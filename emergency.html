<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HouseVault â€“ Emergency Contacts</title>

    <link rel="stylesheet" href="vault_card.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=arrow_back_ios"
    />
  </head>

  <body>
    <!-- TOP NAVIGATION -->
    <header class="top-bar">
      <a href="dashboard.html" class="home"
        ><span class="material-symbols-outlined">arrow_back_ios</span
        >HouseVault</a
      >
    </header>

    <!-- PAGE TITLE -->
    <section class="page-title">
      <h1>EMERGENCY CONTACTS</h1>
    </section>

    <!-- SEARCH BAR -->
    <section class="search-section">
      <input
        type="search"
        placeholder="Search emergency contacts..."
        aria-label="Search emergency contacts"
      />
    </section>

    <!-- CONTACTS TABLE -->
    <main class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Relation</th>
            <th>Phone Number</th>
            <th>Action</th>
          </tr>
        </thead>

        <tbody id="emergencyTableBody">
          <!-- <tr>
            <td>Family Doctor</td>
            <td>Medical</td>
            <td>+91 97XXXXXX45</td>
            <td>High</td>
                    <td>
                        <button class="icon-btn">
                            <svg viewBox="0 0 24 24">
                                <path d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 11a4 4 0 1 1 0-8 4 4 0 0 1 0 8z"/>
                            </svg>
                        </button>
                    </td>
          </tr> -->
        </tbody>
      </table>
    </main>

    <!-- ADD BUTTON -->
    <button class="add" onclick="openPopup()">+</button>

    <!-- ADD POPUP-->
    <div id="popup" class="popup">
      <!-- ADD BOX -->
      <div class="popup_box">
        <h2>NEW RECORD ENTRY</h2>

        <form>
          <!-- TITLE -->
          <div class="field">
            <label for="emergencyText">Title</label>
            <input
              type="text"
              id="emergencyText"
              name="emergencyText"
              placeholder="Enter record title"
            />
          </div>

          <!-- CATEGORY + EXPIRY -->
          <div class="row">
            <div class="field">
              <label for="emergencyCategory">Category</label>
              <select id="emergencyCategory" name="noteCategory">
                <option value="medical">Medical</option>
                <option value="documents">Documents</option>
                <option value="notes">Notes</option>
                <option value="emergency">Emergency</option>
              </select>
            </div>

            <div class="field">
              <label for="emergencyRelation">Relation</label>
              <input
                type="text"
                id="emergencyRelation"
                name="emergencyRelation"
                placeholder="Enter Relation"
              />
            </div>
          </div>
          <div class="field">
            <label>Phone Number</label>
            <input type="tel" id="emergencyContact" name="emergencyContact" />
          </div>

          <!-- ACTIONS -->
          <div class="actions">
            <button type="button" class="cancel" onclick="closePopup()">
              Cancel
            </button>
            <button type="button" class="save" onclick="saveRecord()">
              Encrypt & Save
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      function openPopup() {
        document.getElementById("popup").style.display = "flex";
      }

      function closePopup() {
        document.getElementById("popup").style.display = "none";
      }

      //   storage
      let data = JSON.parse(localStorage.getItem("housevaultData"));

      if (!data || !data.notes) {
        data = {
          medical: [],
          documents: [],
          notes: [],
          emergency: [],
        };
        localStorage.setItem("housevaultData", JSON.stringify(data));
      }

      function saveRecord() {
        const text = document.getElementById("emergencyText").value.trim();
        const category = document.getElementById("emergencyCategory").value;
        const relation = document.getElementById("emergencyRelation").value;
        const contact = document.getElementById("emergencyContact").value;

        if (text === "" || relation === "" || contact === "") {
          alert("Please fill all fields");
          return;
        }

        const data = JSON.parse(localStorage.getItem("housevaultData"));

        const newRecord = {
          id: Date.now(), // unique id, used further for remove button
          text: text,
          relation: relation,
          contact: contact,
        };

        if (category === "emergency") {
          data[category].push(newRecord);
          localStorage.setItem("housevaultData", JSON.stringify(data));
          addToTable(newRecord);
        } 
        else {
          alert("Enter correct category");
        }

        closePopup();
        clearForm();
      }

      // add notes to table on the screen

      function addToTable(record) {
        const tableBody = document.getElementById("emergencyTableBody");

        const row = document.createElement("tr");
        row.setAttribute("data-id", record.id); // to give the row a unique id

        row.innerHTML = `
    <td>${record.text}</td>
    <td>${record.relation}</td>   
    <td>${record.contact}</td>          
    
    <td>
      <button class="remove-btn icon-btn" style="
                    padding: 6px 14px;
                    border-radius: 20px;
                    font-size: 0.85rem;
                    background: rgba(255, 90, 90, 0.2);
                    color: #ff8c8c;
                  " onclick="removeItem(${record.id})">Remove</button>
    </td>`;

        tableBody.appendChild(row);
      }

      //load stored data on screen

      function loadData() {
        const data = JSON.parse(localStorage.getItem("housevaultData"));
        if (!data) return; //if data is null or undefined exit the function

        data.emergency.forEach(addToTable); //For each element(every contact) stored in localStorage, add it as a row in the table
      }

      //other functions

      // function formatDate(dateStr) {
      //   const date = new Date(dateStr);
      //   return date.toLocaleString("en-US", {
      //     date:"numeric",
      //     month: "short",
      //     year: "numeric",
      //   });
      // }

      function clearForm() {
        document.getElementById("emergencyText").value = "";
        document.getElementById("emergencyRelation").value = "";
        document.getElementById("emergencyContact").value = "";
      }

      //REMOVE ITEM

      function removeItem(id) {
        const data = JSON.parse(localStorage.getItem("housevaultData"));
        //  Remove from localStorage
        for (let i = 0; i < data.emergency.length; i++) {
          if (data.emergency[i].id === id) {
            data.emergency.splice(i, 1); // delete that note which has that id whose remove btn is clicked(index, no. of elem to be del)
            break;
          }
        }
        localStorage.setItem("housevaultData", JSON.stringify(data)); //store modifies data

        //  Remove from screen
        const row = document.querySelector(`tr[data-id="${id}"]`);
        if (row) {
          row.remove();
        }
      }
      //to load notes when page is refreshed
      window.onload = loadData();
    </script>
  </body>
</html>
